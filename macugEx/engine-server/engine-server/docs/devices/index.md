### 服务器访问地址

根据腕表客户号,访问[配置服务](../watch/config/#_1)获取域名等配置信息

### 客户号列表

客户号|代理商
-----|-----
0x0000|内测
0x0001|迪士尼

### 通信流程

![communication](/img/communication.png)

1. 腕表开机时用默认域名，默认端口登陆服务器，为TCP长连接方式；
2. 默认每隔5分钟发送腕表心跳包（上传定位数据），维持长连接在线，不启用TCP Keep-alive参数，使用心跳包维持连接；
3. 所有指令的默认超时时间为15s；
4. 作为心跳包上传定位信息时，每次开机时为上次0x04指令设置的心跳间隔，如果没有设置过心跳间隔，则默认为5分钟；
5. 腕表发送任何指令在超时时间内未收到服务器确认包，则连接超时，将自身心跳间隔减少1分钟，心跳间隔最少1分钟，重新登陆后发送未发送成功的指令；
6. 如果登陆时服务器返回确认中带有重定向参数 (新服务器地址、端口)，则腕表使用新的服务器地址和端口进行登录，直到返回登陆成功；

### 激活流程

![active](/img/active_new.png)

1. 默认腕表为未激活状态，需要由APP激活后使用，激活流程如上图;
2. 腕表访问[获取激活二维码](../watch/interface/#_4)获取激活二维码;
3. 腕表每5分钟刷新一次激活二维码;

### 解绑流程

![deactive](/img/deactive.png)

腕表在收到服务器解绑指令，或登录指令返回值收到的腕表状态位为未绑定时，将自身状态视为未绑定，将之前的信息删除，恢复到出厂设置，即每次腕表状态发生变化时，将腕表的旧数据清空。
静音设置为关，名字为空，头像为默认图片，联系人列表为空，等待APP激活，此时仍上传定位（心跳作用），以保证服务器能及时下发激活指令，以及身份信息修改通知。

### 恢复用户流程

![resume](/img/resume.png)

腕表全程没有界面的变化,只是在后台处理APP的短信与蓝牙请求。

### 故事文件格式

![story](/img/story.png)

### tcp指令格式

![instruct](/img/instruct.png)

1. 腕表与服务器的通信指令中目前只含有控制指令，不含有语音图片等数据流（语音、图片用http接口进行上传下载）；
2. 指令用大端方式传输；
3. 腕表主动上传的指令指令类型为奇数；
4. 服务器主动下发的指令指令类型为偶数；
5. 指令中的字符串编码使用utf-16（大端、不带BOM）；
6. 协议头部为1字节版本字段，当前协议版本号为 0x00；
7. 标识字段用于标识腕表和服务器之间每次指令，由主动发起指令的一方生成，返回一方返回确认时标识字段与收到的指令对应相同，2字节；
8. 类型字段为1字节；
9. 长度字节为4字节，标识指令所带数据长度；
10. 数据字段，可选部分，数据的格式各个不同指令不同；
11. 各指令示例中：
    * abcd代表腕表端或服务端产生的随机`标识`
    * 包含 ' ' 的为utf-16BE字符串；
    * 包含 \x 开头为16进制；
    * 其他为数字类型；
12. 各指令中填充字段仅用于4字节对齐；

### http接口说明

1. 接口中[session](../watch/instruct/#0x01)为腕表长连接登陆后获得的加密密匙，用于验证请求合法;
2. 接口中imei参数为腕表imei;
4. 若腕表上传的session无效，则返回文本内容：'unauthorized'; //腕表重新登录以重新获得加密秘钥
5. 若腕表上传的参数无效，则返回文本内容：'invalid parameter';

### mantis地址(buglist)

> <http://115.29.191.125:1234>
